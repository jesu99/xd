<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Película</title>
</head>
<body>
    <h1>Reproductor</h1>
    <video id="videoPlayer" width="640" controls></video>
    <iframe id="iframePlayer" width="640" height="360" style="display:none;"></iframe>
    <p id="mensaje"></p>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const idPelicula = urlParams.get("id");
        const urlVideo = decodeURIComponent(urlParams.get("url"));

        const video = document.getElementById("videoPlayer");
        const iframe = document.getElementById("iframePlayer");
        const mensaje = document.getElementById("mensaje");

        console.log("URL de la película:", urlVideo);

        if (urlVideo) {
            if (urlVideo.includes("mp4") || urlVideo.includes("webm")) {
                video.src = urlVideo;
            } else {
                video.style.display = "none";
                iframe.style.display = "block";
                iframe.src = urlVideo;
            }
        } else {
            mensaje.textContent = "Error: No se encontró la película.";
        }

        let tiempoVisto = 0;
        let intervalo;

        video.addEventListener("play", () => {
            intervalo = setInterval(() => {
                tiempoVisto++;
                console.log(`Tiempo visto: ${tiempoVisto} segundos`);
            }, 1000);
        });

        video.addEventListener("pause", () => clearInterval(intervalo));
        video.addEventListener("ended", () => clearInterval(intervalo));

        window.addEventListener("beforeunload", async () => {
            clearInterval(intervalo);
            if (tiempoVisto >= 3600) {
                await fetch("https://tihvqxujcqladqxucugf.supabase.co/rest/v1/vistas", {
                    method: "POST",
                    headers: {
                        "apikey": "TU_API_KEY",
                        "Authorization": `Bearer TU_API_KEY`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ pelicula_id: idPelicula, tiempo_visto: tiempoVisto })
                });
                console.log("✅ Vista registrada");
            } else {
                console.log("❌ No se registró la vista (menos de 1h)");
            }
        });
    </script>
</body>
</html>

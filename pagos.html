<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Pagos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
            color: #333;
        }
        
        .payment-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            padding: 20px;
            margin-top: 20px;
        }
        
        h2 {
            text-align: center;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .payment-method-details {
            margin-top: 15px;
            display: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .back-button {
            background-color: #95a5a6;
            margin-top: 15px;
        }
        
        .back-button:hover {
            background-color: #7f8c8d;
        }
        
        .history-container {
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .status-pending {
            color: #f39c12;
        }
        
        .status-completed {
            color: #27ae60;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
        }
        
        .success-message {
            color: #27ae60;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h2>Configuración de Pagos</h2>
    
    <div class="payment-container">
        <div id="user-balance" class="form-group">
            <h3>Tu saldo actual: <span id="balance-amount">0.00</span> USD</h3>
            <p>Monto mínimo para solicitar pago: 5.00 USD</p>
        </div>
        
        <form id="payment-form">
            <div class="form-group">
                <label for="payment-method">Selecciona tu método de pago:</label>
                <select id="payment-method" onchange="togglePaymentDetails()">
                    <option value="">-- Seleccionar método --</option>
                    <option value="paypal">PayPal</option>
                    <option value="bank">Transferencia Bancaria</option>
                    <option value="crypto">Criptomoneda</option>
                </select>
            </div>
            
            <div id="paypal-details" class="payment-method-details">
                <div class="form-group">
                    <label for="paypal-email">Correo de PayPal:</label>
                    <input type="email" id="paypal-email" placeholder="tucorreo@ejemplo.com">
                </div>
            </div>
            
            <div id="bank-details" class="payment-method-details">
                <div class="form-group">
                    <label for="bank-name">Nombre del Banco:</label>
                    <input type="text" id="bank-name" placeholder="Banco Popular">
                </div>
                <div class="form-group">
                    <label for="account-number">Número de Cuenta:</label>
                    <input type="text" id="account-number" placeholder="00000000000000000">
                </div>
                <div class="form-group">
                    <label for="account-holder">Titular de la Cuenta:</label>
                    <input type="text" id="account-holder" placeholder="Tu nombre completo">
                </div>
            </div>
            
            <div id="crypto-details" class="payment-method-details">
                <div class="form-group">
                    <label for="crypto-type">Tipo de Criptomoneda:</label>
                    <select id="crypto-type">
                        <option value="btc">Bitcoin (BTC)</option>
                        <option value="eth">Ethereum (ETH)</option>
                        <option value="usdt">Tether (USDT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="wallet-address">Dirección de Billetera:</label>
                    <input type="text" id="wallet-address" placeholder="Tu dirección de billetera">
                </div>
            </div>
            
            <div id="message-container"></div>
            
            <button type="submit" id="save-button">Guardar Método de Pago</button>
            <button type="button" id="request-payment" disabled>Solicitar Pago</button>
            <button type="button" class="back-button" onclick="window.location.href='dashboard.html'">Volver al Dashboard</button>
        </form>
        
        <div class="history-container">
            <h3>Historial de Pagos</h3>
            <table id="payment-history">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Método</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="payment-history-body">
                    <!-- Los registros de pagos se cargarán aquí dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const supabaseUrl = "https://tihvqxujcqladqxucugf.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHZxeHVqY3FsYWRxeHVjdWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyMDYwNTUsImV4cCI6MjA1ODc4MjA1NX0.p9lMEnhHfA10JSiGv9jJZHj0Zf5SCnZFtER5GYvqI5g";
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let userData = null;
        let userEmail = null;
        
        // Al cargar la página
        window.onload = async function() {
            try {
                const token = sessionStorage.getItem("token");
                const user_id = sessionStorage.getItem("user_id");
                
                if (!token || !user_id) {
                    window.location.href = "login.html";
                    return;
                }
                
                // Obtener datos del usuario
                const { data, error } = await supabase
                    .from("usuarios")
                    .select("*")
                    .eq("id", user_id)
                    .single();
                
                if (error || !data) {
                    console.error("Error al obtener usuario:", error);
                    window.location.href = "login.html";
                    return;
                }
                
                userData = data;
                userEmail = data.email;
                
                // Usar el campo balance de la tabla usuarios
                const balance = data.balance || 0;
                
                // Mostrar el saldo desde la base de datos
                document.getElementById("balance-amount").innerText = balance.toFixed(2);
                
                // Habilitar o deshabilitar el botón de solicitar pago según el saldo
                const requestPaymentButton = document.getElementById("request-payment");
                if (balance >= 5.00) {
                    requestPaymentButton.disabled = false;
                }
                
                // Cargar método de pago existente si existe
                if (data.payment_method) {
                    document.getElementById("payment-method").value = data.payment_method;
                    togglePaymentDetails();
                    
                    // Cargar los detalles del método de pago
                    if (data.payment_data) {
                        const paymentData = JSON.parse(data.payment_data);
                        
                        if (data.payment_method === "paypal" && paymentData.email) {
                            document.getElementById("paypal-email").value = paymentData.email;
                        } else if (data.payment_method === "bank") {
                            if (paymentData.bankName) document.getElementById("bank-name").value = paymentData.bankName;
                            if (paymentData.accountNumber) document.getElementById("account-number").value = paymentData.accountNumber;
                            if (paymentData.accountHolder) document.getElementById("account-holder").value = paymentData.accountHolder;
                        } else if (data.payment_method === "crypto") {
                            if (paymentData.cryptoType) document.getElementById("crypto-type").value = paymentData.cryptoType;
                            if (paymentData.walletAddress) document.getElementById("wallet-address").value = paymentData.walletAddress;
                        }
                    }
                }
                
                // Cargar historial de pagos
                await cargarHistorialPagos();
                
            } catch (err) {
                console.error("Error al inicializar:", err);
                mostrarMensaje("Ocurrió un error al cargar tus datos. Por favor, intenta nuevamente.", "error");
            }
        };
        
        // Función para alternar la visualización de los detalles del método de pago
        function togglePaymentDetails() {
            const method = document.getElementById("payment-method").value;
            
            // Ocultar todos los detalles
            document.querySelectorAll(".payment-method-details").forEach(el => {
                el.style.display = "none";
            });
            
            // Mostrar los detalles del método seleccionado
            if (method) {
                document.getElementById(`${method}-details`).style.display = "block";
            }
        }
        
        // Función para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const container = document.getElementById("message-container");
            container.innerHTML = `<p class="${tipo === 'error' ? 'error-message' : 'success-message'}">${mensaje}</p>`;
            
            // Limpiar mensaje después de 5 segundos
            setTimeout(() => {
                container.innerHTML = "";
            }, 5000);
        }
        
        // Función para guardar el método de pago
        document.getElementById("payment-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const method = document.getElementById("payment-method").value;
            
            if (!method) {
                mostrarMensaje("Por favor, selecciona un método de pago.", "error");
                return;
            }
            
            let paymentData = {};
            let datos_pago = "";
            
            // Recopilar datos según el método seleccionado
            if (method === "paypal") {
                const email = document.getElementById("paypal-email").value;
                if (!email) {
                    mostrarMensaje("Por favor, ingresa tu correo de PayPal.", "error");
                    return;
                }
                paymentData = { email };
                datos_pago = email;
            } else if (method === "bank") {
                const bankName = document.getElementById("bank-name").value;
                const accountNumber = document.getElementById("account-number").value;
                const accountHolder = document.getElementById("account-holder").value;
                
                if (!bankName || !accountNumber || !accountHolder) {
                    mostrarMensaje("Por favor, completa todos los campos de la transferencia bancaria.", "error");
                    return;
                }
                
                paymentData = { bankName, accountNumber, accountHolder };
                datos_pago = `Banco: ${bankName}, Cuenta: ${accountNumber}, Titular: ${accountHolder}`;
            } else if (method === "crypto") {
                const cryptoType = document.getElementById("crypto-type").value;
                const walletAddress = document.getElementById("wallet-address").value;
                
                if (!cryptoType || !walletAddress) {
                    mostrarMensaje("Por favor, completa todos los campos de criptomoneda.", "error");
                    return;
                }
                
                paymentData = { cryptoType, walletAddress };
                datos_pago = `${cryptoType.toUpperCase()}: ${walletAddress}`;
            }
            
            try {
                // Actualizar el perfil del usuario con el método de pago
                const { error } = await supabase
                    .from("usuarios")
                    .update({
                        payment_method: method,
                        payment_data: JSON.stringify(paymentData)
                    })
                    .eq("id", sessionStorage.getItem("user_id"));
                
                if (error) {
                    throw error;
                }
                
                mostrarMensaje("Método de pago guardado correctamente.", "success");
                
            } catch (err) {
                console.error("Error al guardar método de pago:", err);
                mostrarMensaje("Ocurrió un error al guardar tu método de pago. Por favor, intenta nuevamente.", "error");
            }
        });
        
        // Función para solicitar un pago
        document.getElementById("request-payment").addEventListener("click", async function() {
            try {
                // Obtener el balance actual del usuario
                const { data: userData, error: userError } = await supabase
                    .from("usuarios")
                    .select("balance, email, payment_method")
                    .eq("id", sessionStorage.getItem("user_id"))
                    .single();
                
                if (userError) {
                    throw userError;
                }
                
                const balance = userData.balance || 0;
                
                if (balance < 5.00) {
                    mostrarMensaje("Necesitas al menos $5.00 USD para solicitar un pago.", "error");
                    return;
                }
                
                const paymentMethod = userData.payment_method;
                if (!paymentMethod) {
                    mostrarMensaje("Por favor, configura un método de pago antes de solicitar.", "error");
                    return;
                }
                
                // Obtener los datos de pago según el método
                let datosPago = "";
                
                if (paymentMethod === "paypal") {
                    datosPago = document.getElementById("paypal-email").value;
                } else if (paymentMethod === "bank") {
                    const banco = document.getElementById("bank-name").value;
                    const cuenta = document.getElementById("account-number").value;
                    const titular = document.getElementById("account-holder").value;
                    datosPago = `Banco: ${banco}, Cuenta: ${cuenta}, Titular: ${titular}`;
                } else if (paymentMethod === "crypto") {
                    const tipo = document.getElementById("crypto-type").value;
                    const wallet = document.getElementById("wallet-address").value;
                    datosPago = `${tipo.toUpperCase()}: ${wallet}`;
                }
                
                // Crear el registro de pago en la tabla pagos
                const { error: insertError } = await supabase
                    .from("pagos")
                    .insert([
                        {
                            usuario_email: userData.email,
                            monto: balance,
                            metodo_pago: paymentMethod,
                            fecha: new Date().toISOString(),
                            datos_pago: datosPago
                        }
                    ]);
                
                if (insertError) {
                    throw insertError;
                }
                
                // Reiniciar el balance a 0 después de solicitar el pago
                const { error: updateError } = await supabase
                    .from("usuarios")
                    .update({
                        balance: 0
                    })
                    .eq("id", sessionStorage.getItem("user_id"));
                
                if (updateError) {
                    throw updateError;
                }
                
                // Actualizar la visualización del balance
                document.getElementById("balance-amount").innerText = "0.00";
                document.getElementById("request-payment").disabled = true;
                
                mostrarMensaje("Solicitud de pago enviada correctamente. Revisa tu historial de pagos para ver el estado.", "success");
                
                // Recargar historial de pagos
                await cargarHistorialPagos();
                
            } catch (err) {
                console.error("Error al solicitar pago:", err);
                mostrarMensaje("Ocurrió un error al solicitar tu pago. Por favor, intenta nuevamente.", "error");
            }
        });
        
        // Función para cargar el historial de pagos
        async function cargarHistorialPagos() {
            try {
                const { data, error } = await supabase
                    .from("pagos")
                    .select("*")
                    .eq("usuario_email", userEmail)
                    .order("fecha", { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                const historyBody = document.getElementById("payment-history-body");
                historyBody.innerHTML = "";
                
                if (data && data.length > 0) {
                    data.forEach(pago => {
                        const row = document.createElement("tr");
                        
                        // Formatear fecha
                        const fecha = new Date(pago.fecha);
                        const fechaFormateada = `${fecha.getDate()}/${fecha.getMonth() + 1}/${fecha.getFullYear()}`;
                        
                        // Estado (en un sistema real se debería agregar una columna estado a la tabla pagos)
                        const estado = "Pendiente"; // Por defecto, todos los pagos son "Pendiente"
                        const estadoClase = "status-pending";
                        
                        row.innerHTML = `
                            <td>${fechaFormateada}</td>
                            <td>$${parseFloat(pago.monto).toFixed(2)}</td>
                            <td>${capitalizeFirstLetter(pago.metodo_pago)}</td>
                            <td class="${estadoClase}">${estado}</td>
                        `;
                        
                        historyBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="4" style="text-align: center;">No hay registros de pagos todavía.</td>`;
                    historyBody.appendChild(row);
                }
                
            } catch (err) {
                console.error("Error al cargar historial de pagos:", err);
                mostrarMensaje("No se pudo cargar el historial de pagos.", "error");
            }
        }
        
        // Función auxiliar para capitalizar la primera letra
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>
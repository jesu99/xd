<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Pagos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
            color: #333;
        }
        
        .payment-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            padding: 20px;
            margin-top: 20px;
        }
        
        h2 {
            text-align: center;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .payment-method-details {
            margin-top: 15px;
            display: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .back-button {
            background-color: #95a5a6;
            margin-top: 15px;
        }
        
        .back-button:hover {
            background-color: #7f8c8d;
        }
        
        .history-container {
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .status-pending {
            color: #f39c12;
        }
        
        .status-completed {
            color: #27ae60;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
        }
        
        .success-message {
            color: #27ae60;
            text-align: center;
            margin: 10px 0;
        }
        
        .verification-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .file-upload {
            margin-top: 10px;
        }
        
        .notification {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h2>Configuración de Pagos</h2>
    
    <div class="payment-container">
        <div id="user-balance" class="form-group">
            <h3>Tu saldo actual: <span id="balance-amount">0.00</span> USD</h3>
            <p>Monto mínimo para solicitar pago: 5.00 USD</p>
        </div>
        
        <div class="notification">
            <p><strong>Importante:</strong> Para verificar tu cuenta y procesar pagos, necesitamos validar tu identidad. Por favor, sube una foto de tu DNI y envía este formulario al correo: <strong>verificacion@ejemplo.com</strong></p>
        </div>
        
        <form id="payment-form">
            <div class="form-group">
                <label for="payment-method">Selecciona tu método de pago:</label>
                <select id="payment-method" onchange="togglePaymentDetails()">
                    <option value="">-- Seleccionar método --</option>
                    <option value="paypal">PayPal</option>
                    <option value="bank">Transferencia Bancaria</option>
                    <option value="binance">Binance</option>
                    <option value="yape">Yape</option>
                </select>
            </div>
            
            <div id="paypal-details" class="payment-method-details">
                <div class="form-group">
                    <label for="paypal-email">Correo de PayPal:</label>
                    <input type="email" id="paypal-email" placeholder="tucorreo@ejemplo.com">
                </div>
            </div>
            
            <div id="bank-details" class="payment-method-details">
                <div class="form-group">
                    <label for="bank-name">Nombre del Banco:</label>
                    <input type="text" id="bank-name" placeholder="Banco Popular">
                </div>
                <div class="form-group">
                    <label for="account-number">Número de Cuenta:</label>
                    <input type="text" id="account-number" placeholder="00000000000000000">
                </div>
                <div class="form-group">
                    <label for="account-holder">Titular de la Cuenta:</label>
                    <input type="text" id="account-holder" placeholder="Tu nombre completo">
                </div>
            </div>
            
            <div id="binance-details" class="payment-method-details">
                <div class="form-group">
                    <label for="binance-id">ID de Binance:</label>
                    <input type="text" id="binance-id" placeholder="Tu ID de Binance">
                </div>
                <div class="form-group">
                    <label for="binance-email">Correo electrónico asociado (opcional):</label>
                    <input type="email" id="binance-email" placeholder="tucorreo@ejemplo.com">
                </div>
            </div>
            
            <div id="yape-details" class="payment-method-details">
                <div class="form-group">
                    <label for="yape-number">Número de celular Yape:</label>
                    <input type="tel" id="yape-number" placeholder="999999999">
                </div>
                <div class="form-group">
                    <label for="yape-name">Nombre completo asociado a Yape:</label>
                    <input type="text" id="yape-name" placeholder="Tu nombre completo">
                </div>
            </div>
            
            <div class="verification-container">
                <h4>Verificación de identidad</h4>
                <p>Para procesar tus pagos, necesitamos verificar tu identidad y confirmar que eres mayor de edad.</p>
                <div class="form-group">
                    <label for="dni-upload">Sube una foto de tu DNI (ambos lados):</label>
                    <input type="file" id="dni-upload" class="file-upload" accept="image/*">
                </div>
                <p><small>Asegúrate que la imagen sea clara y legible. Tu información personal será tratada con confidencialidad.</small></p>
            </div>
            
            <div id="message-container"></div>
            
            <button type="submit" id="save-button">Guardar Método de Pago</button>
            <button type="button" id="request-payment" disabled>Solicitar Pago</button>
            <button type="button" class="back-button" onclick="window.location.href='dashboard.html'">Volver al Dashboard</button>
        </form>
        
        <div class="history-container">
            <h3>Historial de Pagos</h3>
            <table id="payment-history">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Método</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="payment-history-body">
                    <!-- Los registros de pagos se cargarán aquí dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const supabaseUrl = "https://tihvqxujcqladqxucugf.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHZxeHVqY3FsYWRxeHVjdWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyMDYwNTUsImV4cCI6MjA1ODc4MjA1NX0.p9lMEnhHfA10JSiGv9jJZHj0Zf5SCnZFtER5GYvqI5g";
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let userData = null;
        let userEmail = null;
        let dniFile = null;
        
        // Al cargar la página
        window.onload = async function() {
            try {
                const token = sessionStorage.getItem("token");
                const user_id = sessionStorage.getItem("user_id");
                
                if (!token || !user_id) {
                    window.location.href = "login.html";
                    return;
                }
                
                // Obtener datos del usuario
                const { data, error } = await supabase
                    .from("usuarios")
                    .select("*")
                    .eq("id", user_id)
                    .single();
                
                if (error || !data) {
                    console.error("Error al obtener usuario:", error);
                    window.location.href = "login.html";
                    return;
                }
                
                userData = data;
                userEmail = data.email;
                
                // Calcular balance basado en actividad
                const anunciosClickeados = data.anuncios_clickeados || 0;
                const peliculasVistas = data.peliculas_vistas || 0;
                
                // Cálculo según las tarifas: 0.001 por anuncio y 0.003 por película
                const balanceCalculado = (anunciosClickeados * 0.001) + (peliculasVistas * 0.003);
                
                // Mostrar el saldo calculado
                document.getElementById("balance-amount").innerText = balanceCalculado.toFixed(2);
                
                // Habilitar o deshabilitar el botón de solicitar pago según el saldo
                const requestPaymentButton = document.getElementById("request-payment");
                if (balanceCalculado >= 5.00) {
                    requestPaymentButton.disabled = false;
                }
                
                // Cargar método de pago existente si existe
                if (data.payment_method) {
                    document.getElementById("payment-method").value = data.payment_method;
                    togglePaymentDetails();
                    
                    // Cargar los detalles del método de pago
                    if (data.payment_data) {
                        const paymentData = JSON.parse(data.payment_data);
                        
                        if (data.payment_method === "paypal" && paymentData.email) {
                            document.getElementById("paypal-email").value = paymentData.email;
                        } else if (data.payment_method === "bank") {
                            if (paymentData.bankName) document.getElementById("bank-name").value = paymentData.bankName;
                            if (paymentData.accountNumber) document.getElementById("account-number").value = paymentData.accountNumber;
                            if (paymentData.accountHolder) document.getElementById("account-holder").value = paymentData.accountHolder;
                        } else if (data.payment_method === "binance") {
                            if (paymentData.binanceId) document.getElementById("binance-id").value = paymentData.binanceId;
                            if (paymentData.email) document.getElementById("binance-email").value = paymentData.email;
                        } else if (data.payment_method === "yape") {
                            if (paymentData.phoneNumber) document.getElementById("yape-number").value = paymentData.phoneNumber;
                            if (paymentData.fullName) document.getElementById("yape-name").value = paymentData.fullName;
                        }
                    }
                }
                
                // Cargar historial de pagos
                await cargarHistorialPagos();
                
            } catch (err) {
                console.error("Error al inicializar:", err);
                mostrarMensaje("Ocurrió un error al cargar tus datos. Por favor, intenta nuevamente.", "error");
            }
        };
        
        // Manejar la carga del DNI
        document.getElementById("dni-upload").addEventListener("change", function(e) {
            dniFile = e.target.files[0];
            if (dniFile) {
                mostrarMensaje("Imagen de DNI cargada correctamente: " + dniFile.name, "success");
            }
        });
        
        // Función para alternar la visualización de los detalles del método de pago
        function togglePaymentDetails() {
            const method = document.getElementById("payment-method").value;
            
            // Ocultar todos los detalles
            document.querySelectorAll(".payment-method-details").forEach(el => {
                el.style.display = "none";
            });
            
            // Mostrar los detalles del método seleccionado
            if (method) {
                document.getElementById(`${method}-details`).style.display = "block";
            }
        }
        
        // Función para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const container = document.getElementById("message-container");
            container.innerHTML = `<p class="${tipo === 'error' ? 'error-message' : 'success-message'}">${mensaje}</p>`;
            
            // Limpiar mensaje después de 5 segundos
            setTimeout(() => {
                container.innerHTML = "";
            }, 5000);
        }
        
        // Función para guardar el método de pago
        document.getElementById("payment-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const method = document.getElementById("payment-method").value;
            
            if (!method) {
                mostrarMensaje("Por favor, selecciona un método de pago.", "error");
                return;
            }
            
            if (!dniFile) {
                mostrarMensaje("Por favor, sube una foto de tu DNI para verificación.", "error");
                return;
            }
            
            let paymentData = {};
            
            // Recopilar datos según el método seleccionado
            if (method === "paypal") {
                const email = document.getElementById("paypal-email").value;
                if (!email) {
                    mostrarMensaje("Por favor, ingresa tu correo de PayPal.", "error");
                    return;
                }
                paymentData = { email };
            } else if (method === "bank") {
                const bankName = document.getElementById("bank-name").value;
                const accountNumber = document.getElementById("account-number").value;
                const accountHolder = document.getElementById("account-holder").value;
                
                if (!bankName || !accountNumber || !accountHolder) {
                    mostrarMensaje("Por favor, completa todos los campos de la transferencia bancaria.", "error");
                    return;
                }
                
                paymentData = { bankName, accountNumber, accountHolder };
            } else if (method === "binance") {
                const binanceId = document.getElementById("binance-id").value;
                const email = document.getElementById("binance-email").value;
                
                if (!binanceId) {
                    mostrarMensaje("Por favor, ingresa tu ID de Binance.", "error");
                    return;
                }
                
                paymentData = { binanceId, email };
            } else if (method === "yape") {
                const phoneNumber = document.getElementById("yape-number").value;
                const fullName = document.getElementById("yape-name").value;
                
                if (!phoneNumber || !fullName) {
                    mostrarMensaje("Por favor, completa todos los campos de Yape.", "error");
                    return;
                }
                
                paymentData = { phoneNumber, fullName };
            }
            
            try {
                // Simular subida del DNI a Supabase Storage (en una implementación real)
                // const { data, error } = await supabase.storage
                //     .from('verificaciones')
                //     .upload(`${userEmail}/dni.jpg`, dniFile);
                
                // Actualizar el perfil del usuario con el método de pago
                const { error } = await supabase
                    .from("usuarios")
                    .update({
                        payment_method: method,
                        payment_data: JSON.stringify(paymentData),
                        verification_status: "pending"  // Indicar que la verificación está pendiente
                    })
                    .eq("id", sessionStorage.getItem("user_id"));
                
                if (error) {
                    throw error;
                }
                
                // Preparar el correo para el usuario (simulado)
                const emailContent = `
                    Asunto: Verificación de cuenta para pagos
                    
                    Estimado/a usuario/a,
                    
                    Hemos recibido tu solicitud de configuración de método de pago:
                    - Método: ${capitalizeFirstLetter(method)}
                    - Email asociado: ${userEmail}
                    
                    Por favor envía este formulario junto con tu DNI a verificacion@ejemplo.com para completar el proceso.
                    
                    Saludos,
                    El equipo de soporte
                `;
                
                console.log("Email que se enviaría:", emailContent);
                
                mostrarMensaje("Método de pago guardado correctamente. Por favor, envía un correo electrónico a verificacion@ejemplo.com con una copia de tu DNI para completar la verificación.", "success");
                
            } catch (err) {
                console.error("Error al guardar método de pago:", err);
                mostrarMensaje("Ocurrió un error al guardar tu método de pago. Por favor, intenta nuevamente.", "error");
            }
        });
        
        // Función para solicitar un pago
        document.getElementById("request-payment").addEventListener("click", async function() {
            try {
                const balanceText = document.getElementById("balance-amount").innerText;
                const balance = parseFloat(balanceText);
                
                if (balance < 5.00) {
                    mostrarMensaje("Necesitas al menos $5.00 USD para solicitar un pago.", "error");
                    return;
                }
                
                const paymentMethod = document.getElementById("payment-method").value;
                if (!paymentMethod) {
                    mostrarMensaje("Por favor, configura un método de pago antes de solicitar.", "error");
                    return;
                }
                
                // Verificar si el usuario ha sido verificado (en un sistema real)
                if (!userData.verification_status || userData.verification_status !== "approved") {
                    mostrarMensaje("Tu cuenta aún no ha sido verificada. Por favor, envía tu DNI a verificacion@ejemplo.com para completar el proceso.", "error");
                    return;
                }
                
                // Obtener los datos de pago según el método
                let datosPago = "";
                
                if (paymentMethod === "paypal") {
                    datosPago = document.getElementById("paypal-email").value;
                } else if (paymentMethod === "bank") {
                    const banco = document.getElementById("bank-name").value;
                    const cuenta = document.getElementById("account-number").value;
                    const titular = document.getElementById("account-holder").value;
                    datosPago = `Banco: ${banco}, Cuenta: ${cuenta}, Titular: ${titular}`;
                } else if (paymentMethod === "binance") {
                    const binanceId = document.getElementById("binance-id").value;
                    datosPago = `ID Binance: ${binanceId}`;
                } else if (paymentMethod === "yape") {
                    const numero = document.getElementById("yape-number").value;
                    datosPago = `Número Yape: ${numero}`;
                }
                
                // Crear el registro de pago
                const { data, error } = await supabase
                    .from("pagos")
                    .insert([
                        {
                            usuario_email: userEmail,
                            monto: balance,
                            metodo_pago: paymentMethod,
                            fecha: new Date().toISOString(),
                            datos_pago: datosPago
                        }
                    ]);
                
                if (error) {
                    throw error;
                }
                
                // Reiniciar el balance a 0 después de solicitar el pago
                const { error: updateError } = await supabase
                    .from("usuarios")
                    .update({
                        balance: 0
                    })
                    .eq("id", sessionStorage.getItem("user_id"));
                
                if (updateError) {
                    throw updateError;
                }
                
                mostrarMensaje("Solicitud de pago enviada correctamente. Revisa tu historial de pagos para ver el estado.", "success");
                
                // Recargar historial de pagos
                await cargarHistorialPagos();
                
            } catch (err) {
                console.error("Error al solicitar pago:", err);
                mostrarMensaje("Ocurrió un error al solicitar tu pago. Por favor, intenta nuevamente.", "error");
            }
        });
        
        // Función para cargar el historial de pagos
        async function cargarHistorialPagos() {
            try {
                const { data, error } = await supabase
                    .from("pagos")
                    .select("*")
                    .eq("usuario_email", userEmail)
                    .order("fecha", { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                const historyBody = document.getElementById("payment-history-body");
                historyBody.innerHTML = "";
                
                if (data && data.length > 0) {
                    data.forEach(pago => {
                        const row = document.createElement("tr");
                        
                        // Formatear fecha
                        const fecha = new Date(pago.fecha);
                        const fechaFormateada = `${fecha.getDate()}/${fecha.getMonth() + 1}/${fecha.getFullYear()}`;
                        
                        // Estado (simulado, en un sistema real habría un campo para esto)
                        const estado = pago.estado || "Pendiente";
                        const estadoClase = estado === "Completado" ? "status-completed" : "status-pending";
                        
                        row.innerHTML = `
                            <td>${fechaFormateada}</td>
                            <td>$${parseFloat(pago.monto).toFixed(2)}</td>
                            <td>${capitalizeFirstLetter(pago.metodo_pago)}</td>
                            <td class="${estadoClase}">${estado}</td>
                        `;
                        
                        historyBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="4" style="text-align: center;">No hay registros de pagos todavía.</td>`;
                    historyBody.appendChild(row);
                }
                
            } catch (err) {
                console.error("Error al cargar historial de pagos:", err);
                mostrarMensaje("No se pudo cargar el historial de pagos.", "error");
            }
        }
        
        // Función auxiliar para capitalizar la primera letra
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Película</title>
</head>
<body>
    <h1>Reproductor</h1>
    <video id="videoPlayer" width="640" controls></video>
    <p id="mensaje"></p>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const idPelicula = urlParams.get("id");
        const urlVideo = urlParams.get("url");

        const video = document.getElementById("videoPlayer");
        const mensaje = document.getElementById("mensaje");

        if (urlVideo) {
            video.src = decodeURIComponent(urlVideo);
        } else {
            mensaje.textContent = "Error: No se encontró la película.";
        }

        let tiempoVisto = 0;
        let intervalo;

        // Iniciar conteo al reproducir
        video.addEventListener("play", () => {
            intervalo = setInterval(() => {
                tiempoVisto++;
                console.log(`Tiempo visto: ${tiempoVisto} segundos`);
            }, 1000);
        });

        // Pausar conteo si se detiene
        video.addEventListener("pause", () => clearInterval(intervalo));
        video.addEventListener("ended", () => clearInterval(intervalo));

        // Antes de salir, verificar si vio más de 1 hora
        window.addEventListener("beforeunload", async () => {
            clearInterval(intervalo);
            if (tiempoVisto >= 3600) {
                await fetch("https://tihvqxujcqladqxucugf.supabase.co/rest/v1/vistas", {
                    method: "POST",
                    headers: {
                        "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHZxeHVqY3FsYWRxeHVjdWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyMDYwNTUsImV4cCI6MjA1ODc4MjA1NX0.p9lMEnhHfA10JSiGv9jJZHj0Zf5SCnZFtER5GYvqI5g",
                        "Authorization": `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHZxeHVqY3FsYWRxeHVjdWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyMDYwNTUsImV4cCI6MjA1ODc4MjA1NX0.p9lMEnhHfA10JSiGv9jJZHj0Zf5SCnZFtER5GYvqI5g`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ pelicula_id: idPelicula, tiempo_visto: tiempoVisto })
                });
                console.log("✅ Vista registrada");
            } else {
                console.log("❌ No se registró la vista (menos de 1h)");
            }
        });
    </script>
</body>
</html>
